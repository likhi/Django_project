{% extends "blog/base.html" %}
{% load youtube_tags %}
{% block content %}
  <article class="article-card content-section">
    <header class="mb-4">
      <h1 class="mb-2">{{ object.title }}</h1>
      <div class="article-metadata small">By {{ object.author }} â€¢ {{ object.date_posted }}</div>
    </header>

    <div class="article-body">
      <p class="article-content">{{ object.content|linebreaks }}</p>

      {% if object.youtube_url %}
        {% with video_id=object.youtube_url|youtube_embed_id %}
          {% if video_id %}
            <div class="my-4 ratio ratio-16x9">
              <iframe src="https://www.youtube.com/embed/{{ video_id }}" title="YouTube video" allowfullscreen></iframe>
            </div>
          {% else %}
            <div class="alert alert-warning" role="alert">Invalid YouTube URL format.</div>
          {% endif %}
        {% endwith %}
      {% endif %}
    </div>

    {% if object.author == request.user %}
      <div class="mt-4 pt-3 border-top">
        <a class="btn btn-outline-secondary btn-sm me-2" href="{% url 'post-update' object.pk %}">Update</a>
        <a class="btn btn-outline-danger btn-sm" href="{% url 'post-delete' object.pk %}">Delete</a>
      </div>
    {% endif %}
  </article>

  <!-- Comments Section -->
  <section class="comments-section mt-5">
    <h2 class="mb-4" style="color: #3b82f6; font-family: 'Merriweather', serif;">Visitor Ideas & Comments</h2>
    
    <!-- Approved Comments -->
    {% if comments %}
      <div class="comments-list mb-5">
        {% for comment in comments %}
          <div class="comment-card mb-3" style="background: #f9fafb; border-left: 4px solid #3b82f6; padding: 1.25rem; border-radius: 0.375rem;">
            <div class="comment-header mb-2">
              <strong style="color: #1f2937;">{{ comment.visitor_name }}</strong>
              <span class="comment-date small text-muted ms-2">
                {{ comment.created_at|date:"F j, Y \a\t g:i a" }}
              </span>
            </div>
            <p class="comment-content mb-0" style="color: #4b5563; line-height: 1.6;">{{ comment.content }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-4">No comments yet. Be the first to share your thoughts!</p>
    {% endif %}
    
    <!-- Comment Form -->
    <div class="comment-form-wrapper" style="background: linear-gradient(135deg, #f0f4f8 0%, #e0f2fe 100%); padding: 2rem; border-radius: 0.5rem; border: 1px solid #cbd5e1;">
      <h3 class="mb-3" style="color: #1f2937; font-size: 1.1rem;">Share Your Ideas ðŸ’¡</h3>
      <form method="post">
        {% csrf_token %}

        {% if request.user.is_authenticated %}
          <p class="mb-2 small text-muted">Commenting as <strong>{{ request.user.get_full_name|default:request.user.username }}</strong> â€” <a href="{% url 'logout' %}?next={{ request.path }}">Logout</a> to comment anonymously.</p>
          <!-- Keep hidden inputs for name/email (prefilled by view) to be saved server-side -->
          <div style="display:none;">
            {{ form.visitor_name }}
            {{ form.visitor_email }}
          </div>

          <div class="mb-3">
            {{ form.content }}
            {% if form.content.errors %}
              <div class="invalid-feedback d-block">{{ form.content.errors }}</div>
            {% endif %}
          </div>
        {% else %}
          <div class="mb-3">
            {{ form.visitor_name }}
            {% if form.visitor_name.errors %}
              <div class="invalid-feedback d-block">{{ form.visitor_name.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ form.visitor_email }}
            {% if form.visitor_email.errors %}
              <div class="invalid-feedback d-block">{{ form.visitor_email.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ form.content }}
            {% if form.content.errors %}
              <div class="invalid-feedback d-block">{{ form.content.errors }}</div>
            {% endif %}
          </div>
        {% endif %}

        <button type="submit" class="btn" style="background-color: #3b82f6; color: white; padding: 0.5rem 1.5rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
          Post Comment
        </button>
      </form>
    </div>
  </section>
{% endblock content %}